name: Verify Nowa-generated annotations

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push: {}

jobs:
  verify-nowa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git (fetch base)
        run: |
          git fetch origin +refs/heads/*:refs/remotes/origin/*

      - name: Run Nowa annotation verification
        env:
          # Use PR base/head when available, otherwise fall back to push values
          BASE_SHA: ${{ github.event.pull_request && github.event.pull_request.base.sha || github.event.before }}
          HEAD_SHA: ${{ github.event.pull_request && github.event.pull_request.head.sha || github.sha }}
        run: |
          chmod +x scripts/ci_verify_nowa_generated.sh
          ./scripts/ci_verify_nowa_generated.sh "$BASE_SHA" "$HEAD_SHA"

      - name: Run Nowa-generated block verification (Python)
        env:
          BASE_SHA: ${{ github.event.pull_request && github.event.pull_request.base.sha || github.event.before }}
          HEAD_SHA: ${{ github.event.pull_request && github.event.pull_request.head.sha || github.sha }}
        run: |
          python3 --version
          chmod +x scripts/ci_verify_nowa_blocks.py
          python3 scripts/ci_verify_nowa_blocks.py "$BASE_SHA" "$HEAD_SHA"
